# Prometheus Configuration

## Files

- `prometheus.yml` - Main Prometheus configuration
- `alert-rules.yml` - Alert rules for AIBetting system
- `alertmanager.yml` - Alertmanager routing and notification configuration

## Useful Queries

### AIBetting Analyst

```promql
# Snapshots processed per minute
rate(aibetting_analyst_snapshots_processed_total[5m]) * 60

# Signals generated by strategy
sum(rate(aibetting_analyst_signals_generated_total[5m])) by (strategy)

# Strategy average confidence
aibetting_analyst_strategy_avg_confidence

# Processing latency P99
histogram_quantile(0.99, rate(aibetting_analyst_processing_latency_seconds_bucket[5m]))

# Average expected ROI
aibetting_analyst_average_expected_roi

# Signals by type and risk
sum(rate(aibetting_analyst_signals_by_type_total[5m])) by (strategy, signal_type, risk_level)
```

### AIBetting Explorer

```promql
# Price updates per minute
rate(aibetting_price_updates_total[5m]) * 60

# Processing latency
aibetting_processing_latency_seconds

# Market updates by event type
sum(rate(aibetting_price_updates_total[5m])) by (event_type)
```

### AIBetting Executor

```promql
# Orders placed per minute
rate(aibetting_executor_orders_placed_total[5m]) * 60

# Orders matched
rate(aibetting_executor_orders_matched_total[5m]) * 60

# Circuit breaker status (0=OK, 1=Triggered)
aibetting_executor_circuit_breaker_status

# Account balance
aibetting_executor_account_balance

# Execution latency P99
histogram_quantile(0.99, rate(aibetting_executor_order_execution_latency_seconds_bucket[5m]))

# Betfair API latency
histogram_quantile(0.99, rate(aibetting_executor_betfair_api_latency_seconds_bucket[5m]))

# Order failure rate
rate(aibetting_executor_orders_failed_total[5m])
```

### Infrastructure

```promql
# Redis memory usage (MB)
redis_memory_used_bytes / 1024 / 1024

# PostgreSQL active connections
pg_stat_database_numbackends

# Node memory available (GB)
node_memory_MemAvailable_bytes / 1024 / 1024 / 1024

# CPU usage
100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### Service Health

```promql
# All services UP
up

# Service UP by job
up{job=~"aibetting-.*"}

# Scrape duration
scrape_duration_seconds
```

## Alert Rules Summary

### Critical Alerts
- `ExecutorBetfairDisconnected` - Betfair API connection lost
- `ExecutorCircuitBreakerTriggered` - Trading halted due to failures
- `CriticalAccountBalance` - Balance below minimum threshold
- `CriticalExposure` - Exposure near maximum limit

### Warning Alerts
- `HighOrderFailureRate` - Excessive order failures
- `HighSignalRejectionRate` - Many signals being rejected
- `HighExecutionLatency` - Slow order execution
- `LowAccountBalance` - Balance approaching minimum
- `HighExposure` - Exposure approaching limit

### Info Alerts
- `NoSignalsReceived` - No signals for extended period
- `NoOrdersPlaced` - No orders placed recently

## Alertmanager Routes

Alerts are routed based on severity:
- **Critical** → Immediate notification (email + Slack)
- **Warning** → Batched notification every 4 hours
- **Info** → Daily digest

Circuit breaker alerts have highest priority with 30-minute repeat interval.
