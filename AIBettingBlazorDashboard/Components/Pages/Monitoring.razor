@page "/monitoring"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Options
@using AIBettingBlazorDashboard.Configuration
@inject NavigationManager NavigationManager
@inject IOptions<MonitoringConfiguration> MonitoringConfig

<PageTitle>Monitoring - AIBetting</PageTitle>

<div class="monitoring-container">
    <div class="monitoring-header">
        <h1>üìä System Monitoring</h1>
        <div class="monitoring-actions">
            <button class="btn btn-primary" @onclick="RefreshDashboard">
                <span class="oi oi-reload"></span> Refresh
            </button>
            <button class="btn btn-secondary" @onclick="OpenGrafanaNewTab">
                <span class="oi oi-external-link"></span> Open in Grafana
            </button>
            <button class="btn btn-info" @onclick="ToggleFullscreen">
                <span class="oi oi-fullscreen-enter"></span> @(isFullscreen ? "Exit" : "Fullscreen")
            </button>
        </div>
    </div>

    <div class="dashboard-selector">
        <label for="dashboardSelect">Select Dashboard:</label>
        <select id="dashboardSelect" class="form-select" @bind="selectedDashboard" @bind:after="LoadDashboard">
            @foreach (var dashboard in config.Dashboards)
            {
                <option value="@dashboard.Key">@dashboard.Value.Name</option>
            }
        </select>
        @if (!string.IsNullOrEmpty(selectedDashboardDescription))
        {
            <small class="text-muted ms-2">@selectedDashboardDescription</small>
        }
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading dashboard...</span>
            </div>
            <p class="mt-3">Loading Grafana dashboard...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">‚ö†Ô∏è Dashboard Error</h4>
            <p>@errorMessage</p>
            <hr>
            <p class="mb-0">
                Make sure Grafana is running: 
                <a href="@config.GrafanaBaseUrl" target="_blank" class="alert-link">@config.GrafanaBaseUrl</a>
            </p>
        </div>
    }
    else
    {
        <div class="grafana-embed @(isFullscreen ? "fullscreen" : "")" @ref="dashboardContainer">
            <iframe 
                id="grafana-iframe"
                src="@embedUrl" 
                frameborder="0" 
                allowfullscreen
                @onload="OnIframeLoaded"
                title="Grafana Dashboard">
            </iframe>
        </div>
    }

    <div class="monitoring-info">
        <div class="info-card">
            <h5>üìà Real-time Metrics</h5>
            <ul>
                <li><strong>Explorer:</strong> Price updates, Processing latency</li>
                <li><strong>Infrastructure:</strong> Redis, PostgreSQL status</li>
                <li><strong>Performance:</strong> CPU, Memory, Network</li>
            </ul>
        </div>
        <div class="info-card">
            <h5>üîó Quick Links</h5>
            <ul>
                <li><a href="@config.PrometheusBaseUrl" target="_blank">Prometheus UI</a></li>
                <li><a href="@config.GrafanaBaseUrl" target="_blank">Grafana Full UI</a></li>
                <li><a href="@config.ExplorerMetricsUrl" target="_blank">Explorer Metrics (Raw)</a></li>
            </ul>
        </div>
        <div class="info-card">
            <h5>‚öôÔ∏è Dashboard Settings</h5>
            <ul>
                <li><strong>Auto-Refresh:</strong> @config.AutoRefreshInterval</li>
                <li><strong>Time Range:</strong> Last @config.DefaultTimeRange</li>
                <li><strong>Mode:</strong> Kiosk (TV mode)</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private MonitoringConfiguration config = new();
    private string selectedDashboard = string.Empty;
    private string selectedDashboardDescription = string.Empty;
    private string embedUrl = string.Empty;
    private bool isLoading = true;
    private bool isFullscreen = false;
    private string? errorMessage = null;
    private ElementReference dashboardContainer;

    protected override void OnInitialized()
    {
        config = MonitoringConfig.Value;
        selectedDashboard = config.DefaultDashboard;
        LoadDashboard();
    }

    private void LoadDashboard()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            if (config.Dashboards.TryGetValue(selectedDashboard, out var dashboardInfo))
            {
                selectedDashboardDescription = dashboardInfo.Description;
                
                // Costruisci URL embed Grafana con parametri da configurazione
                // kiosk=tv: nasconde menu e toolbar
                // refresh: auto-refresh interval
                // from/to: time range
                embedUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}?orgId=1&kiosk=tv&refresh={config.AutoRefreshInterval}&from=now-{config.DefaultTimeRange}&to=now";
                
                // Simula caricamento per smooth UX
                Task.Delay(500).ContinueWith(_ => 
                {
                    InvokeAsync(() =>
                    {
                        isLoading = false;
                        StateHasChanged();
                    });
                });
            }
            else
            {
                errorMessage = $"Dashboard '{selectedDashboard}' not found in configuration";
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
            isLoading = false;
        }
    }

    private void RefreshDashboard()
    {
        // Force iframe reload con cache bypass
        var timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
        if (config.Dashboards.TryGetValue(selectedDashboard, out var dashboardInfo))
        {
            embedUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}?orgId=1&kiosk=tv&refresh={config.AutoRefreshInterval}&from=now-{config.DefaultTimeRange}&to=now&_={timestamp}";
        }
    }

    private void OpenGrafanaNewTab()
    {
        if (config.Dashboards.TryGetValue(selectedDashboard, out var dashboardInfo))
        {
            var fullUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}";
            NavigationManager.NavigateTo(fullUrl, true);
        }
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
    }

    private void OnIframeLoaded()
    {
        isLoading = false;
        StateHasChanged();
    }
}
