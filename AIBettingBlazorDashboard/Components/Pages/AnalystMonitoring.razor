@page "/analyst"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Options
@using AIBettingBlazorDashboard.Configuration
@inject NavigationManager NavigationManager
@inject IOptions<MonitoringConfiguration> MonitoringConfig

<PageTitle>Analyst Monitoring - AIBetting</PageTitle>

<div class="monitoring-container">
    <div class="monitoring-header">
        <h1>üìä Analyst Performance Dashboard</h1>
        <div class="monitoring-actions">
            <button class="btn btn-primary" @onclick="RefreshDashboard">
                <span class="oi oi-reload"></span> Refresh
            </button>
            <button class="btn btn-secondary" @onclick="OpenGrafanaNewTab">
                <span class="oi oi-external-link"></span> Open in Grafana
            </button>
            <button class="btn btn-info" @onclick="OpenAnalystMetrics">
                <span class="oi oi-code"></span> Raw Metrics
            </button>
            <button class="btn btn-success" @onclick="ToggleFullscreen">
                <span class="oi oi-fullscreen-enter"></span> @(isFullscreen ? "Exit" : "Fullscreen")
            </button>
        </div>
    </div>

    <div class="dashboard-info">
        <div class="info-badge">
            <strong>üìà Dashboard:</strong> AIBetting Analyst - Real-time Performance
        </div>
        <div class="info-badge">
            <strong>üîÑ Auto-Refresh:</strong> @config.AutoRefreshInterval
        </div>
        <div class="info-badge">
            <strong>‚è±Ô∏è Time Range:</strong> Last @config.DefaultTimeRange
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading dashboard...</span>
            </div>
            <p class="mt-3">Loading Analyst Performance dashboard...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">‚ö†Ô∏è Dashboard Error</h4>
            <p>@errorMessage</p>
            <hr>
            <p class="mb-0">
                Make sure Grafana is running and the dashboard exists:
                <a href="@($"{config.GrafanaBaseUrl}/d/aibetting-analyst")" target="_blank" class="alert-link">
                    Open Dashboard Directly
                </a>
            </p>
        </div>
    }
    else
    {
        <div class="grafana-embed @(isFullscreen ? "fullscreen" : "")" @ref="dashboardContainer">
            <iframe 
                id="grafana-iframe"
                src="@embedUrl" 
                frameborder="0" 
                allowfullscreen
                @onload="OnIframeLoaded"
                title="Analyst Performance Dashboard">
            </iframe>
        </div>
    }

    <div class="monitoring-info">
        <div class="info-card">
            <h5>üìä Analyst Metrics</h5>
            <ul>
                <li><strong>Snapshots Processed:</strong> Total market snapshots analyzed</li>
                <li><strong>Surebets Found:</strong> Arbitrage opportunities detected</li>
                <li><strong>Signals Generated:</strong> Trading signals published</li>
                <li><strong>Processing Latency:</strong> Analysis performance (p50/p95/p99)</li>
                <li><strong>Expected ROI:</strong> Average expected return on investment</li>
            </ul>
        </div>
        <div class="info-card">
            <h5>üîó Quick Links</h5>
            <ul>
                <li><a href="@config.AnalystMetricsUrl" target="_blank">Analyst Metrics (Raw)</a></li>
                <li><a href="@config.PrometheusBaseUrl/graph?g0.expr=aibetting_analyst_snapshots_processed_total" target="_blank">Prometheus Query</a></li>
                <li><a href="@config.GrafanaBaseUrl/d/aibetting-analyst" target="_blank">Grafana Full UI</a></li>
                <li><a href="/monitoring" class="text-primary">Back to Monitoring Overview</a></li>
            </ul>
        </div>
        <div class="info-card">
            <h5>üéØ Key Performance Indicators</h5>
            <ul>
                <li><strong>Target Latency:</strong> &lt; 100ms per snapshot</li>
                <li><strong>Surebet Threshold:</strong> Min 0.5% profit</li>
                <li><strong>WAP Levels:</strong> 3 depth levels analyzed</li>
                <li><strong>Strategies:</strong> Surebet detection, WoM analysis</li>
            </ul>
        </div>
    </div>

    <div class="alert alert-info mt-3" role="alert">
        <h5 class="alert-heading">üí° Dashboard Tips</h5>
        <ul class="mb-0">
            <li>Use <strong>Time Range</strong> picker (top right) to change data window</li>
            <li>Click on any panel to <strong>zoom in</strong> and see detailed data</li>
            <li>Hover over graphs to see <strong>exact values</strong> at specific times</li>
            <li>Click <strong>Fullscreen</strong> for TV/Kiosk mode presentation</li>
            <li>If dashboard shows "No data", check that <strong>Analyst service is running</strong></li>
        </ul>
    </div>
</div>

@code {
    private MonitoringConfiguration config = new();
    private string embedUrl = string.Empty;
    private bool isLoading = true;
    private bool isFullscreen = false;
    private string? errorMessage = null;
    private ElementReference dashboardContainer;

    protected override void OnInitialized()
    {
        config = MonitoringConfig.Value;
        LoadDashboard();
    }

    private void LoadDashboard()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            if (config.Dashboards.TryGetValue("analyst", out var dashboardInfo))
            {
                // Build Grafana embed URL with kiosk mode
                // kiosk=tv: hides menu and toolbar for clean embed
                // refresh: auto-refresh interval
                // from/to: time range (last 15 minutes by default)
                embedUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}?orgId=1&kiosk=tv&refresh={config.AutoRefreshInterval}&from=now-{config.DefaultTimeRange}&to=now";
                
                // Simulate loading for smooth UX
                Task.Delay(500).ContinueWith(_ => 
                {
                    InvokeAsync(() =>
                    {
                        isLoading = false;
                        StateHasChanged();
                    });
                });
            }
            else
            {
                errorMessage = "Analyst dashboard not found in configuration. Make sure 'analyst' dashboard is configured in appsettings.json";
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
            isLoading = false;
        }
    }

    private void RefreshDashboard()
    {
        // Force iframe reload with cache bypass
        var timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
        if (config.Dashboards.TryGetValue("analyst", out var dashboardInfo))
        {
            embedUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}?orgId=1&kiosk=tv&refresh={config.AutoRefreshInterval}&from=now-{config.DefaultTimeRange}&to=now&_={timestamp}";
        }
        StateHasChanged();
    }

    private void OpenGrafanaNewTab()
    {
        if (config.Dashboards.TryGetValue("analyst", out var dashboardInfo))
        {
            var fullUrl = $"{config.GrafanaBaseUrl}/d/{dashboardInfo.Uid}";
            NavigationManager.NavigateTo(fullUrl, true);
        }
    }

    private void OpenAnalystMetrics()
    {
        NavigationManager.NavigateTo(config.AnalystMetricsUrl, true);
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
    }

    private void OnIframeLoaded()
    {
        isLoading = false;
        StateHasChanged();
    }
}
